name: Reusable App Build

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Image name (e.g., radarr, sonarr)'
        required: true
        type: string
      image_tag:
        description: 'Override tag (skips auto-detection)'
        required: false
        type: string
        default: ''
      build_args:
        description: 'Build args (e.g., PG_VERSION=14)'
        required: false
        type: string
        default: ''
      extra_tags:
        description: 'Extra tags (e.g., latest)'
        required: false
        type: string
        default: ''

env:
  REGISTRY: ghcr.io

jobs:
  # Detect which Containerfiles exist and build dynamic matrix
  detect:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect Containerfiles
        id: set-matrix
        run: |
          # If image_tag is provided, skip auto-detection (manual mode)
          if [ -n "${{ inputs.image_tag }}" ]; then
            matrix='{"include":[{"containerfile":"Containerfile","tag":"${{ inputs.image_tag }}","base_version":"","version_suffix":"","push_latest":""}]}'
            echo "Manual mode: $matrix"
            echo "matrix=$matrix" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Build JSON matrix based on existing Containerfiles
          entries=""
          has_source="false"

          if [ -f "Containerfile" ]; then
            # Check if this single Containerfile handles pkg builds (e.g. redis, transmission)
            if grep -q 'io.daemonless.pkg-source="containerfile"' Containerfile; then
              # PKG SOURCE MODE: 2 builds (pkg, pkg-latest aliased to latest)
              has_source="true" # Treat as source for dependency logic
              entries+='{"containerfile":"Containerfile","tag":"pkg","base_version":"15-quarterly","version_suffix":"-pkg","push_latest":""},'
              entries+='{"containerfile":"Containerfile","tag":"pkg-latest","base_version":"15","version_suffix":"-pkg-latest","push_latest":"--alias latest"},'
            else
              # STANDARD MODE: Source build (latest)
              has_source="true"
              entries+='{"containerfile":"Containerfile","tag":"latest","base_version":"","version_suffix":"","push_latest":""},'
            fi
          fi

          if [ -f "Containerfile.pkg" ]; then
            entries+='{"containerfile":"Containerfile.pkg","tag":"pkg","base_version":"15-quarterly","version_suffix":"-pkg","push_latest":""},'
            # If no source build, pkg-latest should also be tagged as "latest"
            if [ "$has_source" = "false" ]; then
              entries+='{"containerfile":"Containerfile.pkg","tag":"pkg-latest","base_version":"15","version_suffix":"-pkg-latest","push_latest":"--push-latest"},'
            else
              entries+='{"containerfile":"Containerfile.pkg","tag":"pkg-latest","base_version":"15","version_suffix":"-pkg-latest","push_latest":""},'
            fi
          fi

          # Remove trailing comma and wrap in matrix format
          entries="${entries%,}"
          matrix="{\"include\":[${entries}]}"

          echo "Detected matrix: $matrix"
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  build:
    needs: detect
    if: ${{ needs.detect.outputs.matrix != '{"include":[]}' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}

    steps:
      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare VM data directory
        run: sudo mkdir -p /mnt/freebsd-vm && sudo chmod 777 /mnt/freebsd-vm

      - name: Build in FreeBSD VM (${{ matrix.tag }})
        uses: vmactions/freebsd-vm@v1.3.5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        with:
          release: "15.0"
          usesh: true
          copyback: false
          data-dir: /mnt/freebsd-vm
          envs: "GITHUB_TOKEN GITHUB_ACTOR"
          prepare: |
            # Create 4GB swap for heavy builds
            dd if=/dev/zero of=/swapfile bs=1m count=4096
            chmod 0600 /swapfile
            mdconfig -a -t vnode -f /swapfile -u 0
            swapon /dev/md0

            pkg install -y podman
            rm -rf /var/db/containers /var/lib/containers 2>/dev/null || true
            kldload pf
            sysctl net.inet.ip.forwarding=1
          run: |
            set -e
            # Download shared build script (pinned to version)
            mkdir -p scripts
            fetch -qo scripts/build.sh \
              "https://raw.githubusercontent.com/daemonless/daemonless/build-v1.5.0/scripts/build.sh"
            chmod +x scripts/build.sh

            PUSH_FLAG=""
            if [ "${{ github.event_name }}" != "pull_request" ]; then
              PUSH_FLAG="--login --push"
            fi

            BASE_VERSION_ARG=""
            if [ -n "${{ matrix.base_version }}" ]; then
              BASE_VERSION_ARG="--base-version ${{ matrix.base_version }}"
            fi

            BUILD_ARGS=""
            if [ -n "${{ inputs.build_args }}" ]; then
              # Handle comma-separated build args
              for arg in $(echo "${{ inputs.build_args }}" | tr ',' ' '); do
                BUILD_ARGS="$BUILD_ARGS --build-arg $arg"
              done
            fi

            EXTRA_TAGS=""
            if [ -n "${{ inputs.extra_tags }}" ]; then
              # Handle comma-separated extra tags
              for tag in $(echo "${{ inputs.extra_tags }}" | tr ',' ' '); do
                EXTRA_TAGS="$EXTRA_TAGS --alias $tag"
              done
            fi

            ./scripts/build.sh \
              --registry ${{ env.REGISTRY }} \
              --image ${{ env.REGISTRY }}/daemonless/${{ inputs.image_name }} \
              --containerfile ${{ matrix.containerfile }} \
              $BASE_VERSION_ARG \
              $BUILD_ARGS \
              --tag ${{ matrix.tag }} \
              --tag-version \
              --version-suffix "${{ matrix.version_suffix }}" \
              ${{ matrix.push_latest }} \
              $EXTRA_TAGS \
              --skip-wip \
              $PUSH_FLAG
