name: Check for Package Updates

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:

jobs:
  check-updates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check versions in FreeBSD VM
        uses: vmactions/freebsd-vm@v1.3.4
        with:
          release: "15.0"
          usesh: true
          copyback: true
          envs: 'GH_TOKEN'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e

          # Install dependencies
          pkg update -q
          pkg install -y skopeo gh jq

          # Run dynamic version checker (handles both pkg and upstream)
          chmod +x scripts/check-upstream-dynamic.sh
          ./scripts/check-upstream-dynamic.sh > upstream-versions.txt

          cat upstream-versions.txt

      - name: Compare with stored versions
        id: compare
        run: |
          set -e

          CHANGES=""

          # Compare versions from dynamic script output
          if [ -f upstream-versions.txt ] && [ -f versions.json ]; then
            while read -r app ver; do
              [ -z "$app" ] && continue
              stored=$(jq -r ".upstream.\"$app\" // \"\"" versions.json)
              if [ -n "$stored" ] && [ "$stored" != "$ver" ] && [ "$ver" != "unknown" ]; then
                CHANGES="${CHANGES}${app} ${stored}->${ver}\n"
              fi
            done < upstream-versions.txt
          fi

          if [ -n "$CHANGES" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "changes<<EOF" >> $GITHUB_OUTPUT
            echo -e "$CHANGES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "::notice::Version changes detected"
            echo -e "$CHANGES"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "::notice::No version changes detected"
          fi

      - name: Update versions.json
        if: steps.compare.outputs.changed == 'true'
        run: |
          set -e

          # Update upstream versions from dynamic script output
          while read -r app ver; do
            [ -z "$app" ] && continue
            if [ "$ver" != "unknown" ]; then
              jq ".upstream.\"$app\" = \"$ver\"" versions.json > tmp.json && mv tmp.json versions.json
            fi
          done < upstream-versions.txt

          # Update timestamp
          jq ".last_check = \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"" versions.json > tmp.json && mv tmp.json versions.json

      - name: Commit changes
        if: steps.compare.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add versions.json
          git commit -m "Update versions: $(echo '${{ steps.compare.outputs.changes }}' | head -3 | tr '\n' ' ')"
          git push

      - name: Trigger rebuilds
        if: steps.compare.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.REBUILD_TOKEN }}
        run: |
          set -e

          # Parse changes and trigger appropriate builds
          echo '${{ steps.compare.outputs.changes }}' | while read -r line; do
            [ -z "$line" ] && continue

            type=$(echo "$line" | cut -d: -f1)
            pkg=$(echo "$line" | cut -d: -f2 | cut -d' ' -f1)

            echo "Processing: $type $pkg"

            # Determine which repos to rebuild based on dependencies.json
            # For now, just trigger the direct repo
            case "$pkg" in
              radarr|sonarr|prowlarr|lidarr|readarr|sabnzbd|tautulli|jellyfin|traefik|gitea|tailscale|transmission-daemon|vaultwarden|smokeping|nextcloud-php83|woodpecker|mealie|n8n|overseerr|openspeedtest)
                repo="${pkg%-*}"  # Remove -daemon suffix etc
                [ "$pkg" = "transmission-daemon" ] && repo="transmission"
                [ "$pkg" = "nextcloud-php83" ] && repo="nextcloud"

                echo "Triggering build for: $repo"
                gh workflow run build.yml --repo "daemonless/$repo" --ref main || echo "Failed to trigger $repo"
                ;;
              s6|execline)
                echo "Base package changed, triggering base rebuild"
                gh workflow run build.yml --repo "daemonless/base" --ref main || true
                ;;
              sqlite3|icu)
                echo "arr-base package changed, triggering arr-base rebuild"
                gh workflow run build.yml --repo "daemonless/arr-base" --ref main || true
                ;;
              nginx)
                echo "nginx-base package changed, triggering nginx-base rebuild"
                gh workflow run build.yml --repo "daemonless/nginx-base" --ref main || true
                ;;
            esac
          done
